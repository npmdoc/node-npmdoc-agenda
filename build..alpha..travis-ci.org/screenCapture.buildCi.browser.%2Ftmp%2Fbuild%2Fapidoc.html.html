<html><head></head><body><div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a href="https://github.com/rschmukler/agenda#readme">agenda (v0.9.1)</a>
</h1>
<h4>Light weight job scheduler for Node.js</h4>
<div class="apidocSectionDiv"><a href="#apidoc.tableOfContents" id="apidoc.tableOfContents"><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.agenda">module agenda</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda">
            function <span class="apidocSignatureSpan"></span>agenda
            <span class="apidocSignatureSpan">(config, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job">
            function <span class="apidocSignatureSpan">agenda.</span>job
            <span class="apidocSignatureSpan">(args)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.super_">
            function <span class="apidocSignatureSpan">agenda.</span>super_
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">agenda.</span>agenda.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">agenda.</span>job.prototype</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.agenda.agenda">module agenda.agenda</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.agenda">
            function <span class="apidocSignatureSpan">agenda.</span>agenda
            <span class="apidocSignatureSpan">(config, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.super_">
            function <span class="apidocSignatureSpan">agenda.agenda.</span>super_
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.agenda.agenda.prototype">module agenda.agenda.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype._findAndLockNextJob">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>_findAndLockNextJob
            <span class="apidocSignatureSpan">(jobName, definition, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype._unlockJobs">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>_unlockJobs
            <span class="apidocSignatureSpan">(done)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.cancel">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>cancel
            <span class="apidocSignatureSpan">(query, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.create">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>create
            <span class="apidocSignatureSpan">(name, data)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.database">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>database
            <span class="apidocSignatureSpan">(url, collection, options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.db_init">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>db_init
            <span class="apidocSignatureSpan">( collection, cb )</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.defaultConcurrency">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>defaultConcurrency
            <span class="apidocSignatureSpan">(num)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.defaultLockLifetime">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>defaultLockLifetime
            <span class="apidocSignatureSpan">(ms)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.defaultLockLimit">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>defaultLockLimit
            <span class="apidocSignatureSpan">(num)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.define">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>define
            <span class="apidocSignatureSpan">(name, options, processor)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.every">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>every
            <span class="apidocSignatureSpan">(interval, names, data, options, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.jobs">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>jobs
            <span class="apidocSignatureSpan">( query, cb )</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.lockLimit">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>lockLimit
            <span class="apidocSignatureSpan">(num)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.maxConcurrency">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>maxConcurrency
            <span class="apidocSignatureSpan">(num)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.mongo">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>mongo
            <span class="apidocSignatureSpan">( mdb, collection, cb )</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.name">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>name
            <span class="apidocSignatureSpan">(name)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.now">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>now
            <span class="apidocSignatureSpan">(name, data, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.processEvery">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>processEvery
            <span class="apidocSignatureSpan">(time)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.purge">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>purge
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.saveJob">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>saveJob
            <span class="apidocSignatureSpan">(job, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.schedule">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>schedule
            <span class="apidocSignatureSpan">(when, names, data, cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.start">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>start
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.agenda.prototype.stop">
            function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>stop
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.agenda.job">module agenda.job</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.job">
            function <span class="apidocSignatureSpan">agenda.</span>job
            <span class="apidocSignatureSpan">(args)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.agenda.job.prototype">module agenda.job.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.computeNextRunAt">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>computeNextRunAt
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.disable">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>disable
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.enable">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>enable
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.fail">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>fail
            <span class="apidocSignatureSpan">(reason)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.isRunning">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>isRunning
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.priority">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>priority
            <span class="apidocSignatureSpan">(priority)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.remove">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>remove
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.repeatAt">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>repeatAt
            <span class="apidocSignatureSpan">(time)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.repeatEvery">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>repeatEvery
            <span class="apidocSignatureSpan">(interval, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.run">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>run
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.save">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>save
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.schedule">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>schedule
            <span class="apidocSignatureSpan">(time)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.toJSON">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>toJSON
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.touch">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>touch
            <span class="apidocSignatureSpan">(cb)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.agenda.job.prototype.unique">
            function <span class="apidocSignatureSpan">agenda.job.prototype.</span>unique
            <span class="apidocSignatureSpan">(unique, opts)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.agenda" id="apidoc.module.agenda">module agenda</a></h1>


    <h2>
        <a href="#apidoc.element.agenda.agenda" id="apidoc.element.agenda.agenda">
        function <span class="apidocSignatureSpan"></span>agenda
        <span class="apidocSignatureSpan">(config, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">agenda = function (config, cb) {
  if (!(this instanceof Agenda)) {
    return new Agenda(config);
  }
  config = config ? config : {};
  this._name = config.name;
  this._processEvery = humanInterval(config.processEvery) || humanInterval('5 seconds');
  this._defaultConcurrency = config.defaultConcurrency || 5;
  this._maxConcurrency = config.maxConcurrency || 20;
  this._defaultLockLimit = config.defaultLockLimit || 0;
  this._lockLimit = config.lockLimit || 0;
  this._definitions = {};
  this._runningJobs = [];
  this._lockedJobs = [];
  this._jobQueue = [];
  this._defaultLockLifetime = config.defaultLockLifetime || 10 * 60 * 1000; //10 minute default lockLifetime

  this._isLockingOnTheFly = false;
  this._jobsToLock = [];
  if (config.mongo) {
    this.mongo(config.mongo, config.db ? config.db.collection : undefined, cb);
  } else if (config.db) {
    this.database(config.db.address, config.db.collection, config.db.options, cb);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job" id="apidoc.element.agenda.job">
        function <span class="apidocSignatureSpan">agenda.</span>job
        <span class="apidocSignatureSpan">(args)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Job(args) {
  args = args || {};

  // Remove special args
  this.agenda = args.agenda;
  delete args.agenda;

  // Process args
  args.priority = parsePriority(args.priority) || 0;

  // Set attrs to args
  var attrs = {};
  for (var key in args) {
    if (args.hasOwnProperty(key)) {
      attrs[key] = args[key];
    }
  }

  // Set defaults if undefined
  attrs.nextRunAt = attrs.nextRunAt || new Date();
  attrs.type = attrs.type || 'once';
  this.attrs = attrs;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.super_" id="apidoc.element.agenda.super_">
        function <span class="apidocSignatureSpan">agenda.</span>super_
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function EventEmitter() {
  EventEmitter.init.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>






</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.agenda.agenda" id="apidoc.module.agenda.agenda">module agenda.agenda</a></h1>


    <h2>
        <a href="#apidoc.element.agenda.agenda.agenda" id="apidoc.element.agenda.agenda.agenda">
        function <span class="apidocSignatureSpan">agenda.</span>agenda
        <span class="apidocSignatureSpan">(config, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">agenda = function (config, cb) {
  if (!(this instanceof Agenda)) {
    return new Agenda(config);
  }
  config = config ? config : {};
  this._name = config.name;
  this._processEvery = humanInterval(config.processEvery) || humanInterval('5 seconds');
  this._defaultConcurrency = config.defaultConcurrency || 5;
  this._maxConcurrency = config.maxConcurrency || 20;
  this._defaultLockLimit = config.defaultLockLimit || 0;
  this._lockLimit = config.lockLimit || 0;
  this._definitions = {};
  this._runningJobs = [];
  this._lockedJobs = [];
  this._jobQueue = [];
  this._defaultLockLifetime = config.defaultLockLifetime || 10 * 60 * 1000; //10 minute default lockLifetime

  this._isLockingOnTheFly = false;
  this._jobsToLock = [];
  if (config.mongo) {
    this.mongo(config.mongo, config.db ? config.db.collection : undefined, cb);
  } else if (config.db) {
    this.database(config.db.address, config.db.collection, config.db.options, cb);
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.super_" id="apidoc.element.agenda.agenda.super_">
        function <span class="apidocSignatureSpan">agenda.agenda.</span>super_
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function EventEmitter() {
  EventEmitter.init.call(this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.agenda.agenda.prototype" id="apidoc.module.agenda.agenda.prototype">module agenda.agenda.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype._findAndLockNextJob" id="apidoc.element.agenda.agenda.prototype._findAndLockNextJob">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>_findAndLockNextJob
        <span class="apidocSignatureSpan">(jobName, definition, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_findAndLockNextJob = function (jobName, definition, cb) {
  var self = this,
      now = new Date(),
      lockDeadline = new Date(Date.now().valueOf() - definition.lockLifetime);

  // Don't try and access Mongo Db if we've lost connection to it. Also see clibu_automation.js db.on.close code. NF 29/04/2015
  // Trying to resolve crash on Dev PC when it resumes from sleep.
  var s = this._mdb.s || this._mdb.db.s;
  if (s.topology.connections().length === 0) {
    cb(new Error( 'No MongoDB Connection'));
  } else {
    this._collection.findAndModify(
      {
        $or: [
          {name: jobName, lockedAt: null, nextRunAt: {$lte: this._nextScanAt}, disabled: { $ne: true }},
          {name: jobName, lockedAt: {$exists: false}, nextRunAt: {$lte: this._nextScanAt}, disabled: { $ne: true }},
          {name: jobName, lockedAt: {$lte: lockDeadline}, disabled: { $ne: true }}
        ]
      },
      {'priority': -1},  // sort
      {$set: {lockedAt: now}},  // Doc
      {'new': true},  // options
      function (err, result) {
        var job;
        if (!err &amp;&amp; result.value) {
          job = createJob(self, result.value);
        }
        cb(err, job);
      }
    );
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype._unlockJobs" id="apidoc.element.agenda.agenda.prototype._unlockJobs">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>_unlockJobs
        <span class="apidocSignatureSpan">(done)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_unlockJobs = function (done) {
  var jobIds = this._lockedJobs.map(function (job) {
    return job.attrs._id;
  });
  this._collection.updateMany({_id: { $in: jobIds } }, { $set: { lockedAt: null } }, done);    // NF refactored .update() 22/04/
2015
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.cancel" id="apidoc.element.agenda.agenda.prototype.cancel">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>cancel
        <span class="apidocSignatureSpan">(query, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">cancel = function (query, cb) {
  this._collection.deleteMany( query, function( error, result ){
    if (cb) {
      cb( error, result &amp;&amp; result.result ? result.result.n : undefined );
    }
  });

}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
```

### cancel(mongodb-native query, cb)

Cancels any jobs matching the passed mongodb-native query, and removes them from the database.

```js
agenda.<span class="apidocCodeKeywordSpan">cancel</span>({name: 'printAnalyticsReport'}, function(err, numRemoved) {
});
```

This functionality can also be achieved by first retrieving all the jobs from the database using `agenda.jobs()`, looping through
 the resulting array and calling `job.remove()` on each. It is however preferable to use `agenda.cancel()` for this use case, as
 this ensures the operation is atomic.

### purge(cb)
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.create" id="apidoc.element.agenda.agenda.prototype.create">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>create
        <span class="apidocSignatureSpan">(name, data)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">create = function (name, data) {
  var priority = this._definitions[name] ? this._definitions[name].priority : 0;
  var job = new Job({name: name, data: data, type: 'normal', priority: priority, agenda: this});
  return job;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  agenda.schedule('in 20 minutes', 'send email report', {to: 'admin@example.com'});
  agenda.start();
});
```

```js
agenda.on('ready', function() {
  var weeklyReport = agenda.<span class="apidocCodeKeywordSpan">create</span>('send email report', {to: 'another-
guy@example.com'})
  weeklyReport.repeatEvery('1 week').save();
  agenda.start();
});
```

# Full documentation
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.database" id="apidoc.element.agenda.agenda.prototype.database">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>database
        <span class="apidocSignatureSpan">(url, collection, options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">database = function (url, collection, options, cb) {
  if (!url.match(/^mongodb:\/\/.*/)) {
    url = 'mongodb://' + url;
  }

  collection = collection || 'agendaJobs';
  options = options || {};
  var self = this;

  MongoClient.connect(url, options, function ( error, db ){
    if (error) {
      if (cb) {
        cb(error, null);
      } else {
        throw error;
      }

      return;
    }

    self._mdb = db;
    self.db_init( collection, cb );
  });
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

## Configuring an agenda
All configuration methods are chainable, meaning you can do something like:

```js
var agenda = new Agenda();
agenda
  .<span class="apidocCodeKeywordSpan">database</span>(...)
  .processEvery('3 minutes')
  ...;
```

Agenda uses [Human Interval](http://github.com/rschmukler/human-interval) for specifying the intervals. It supports the following
 units:

`seconds`, `minutes`, `hours`, `days`,`weeks`, `months` -- assumes 30 days, `years` -- assumes 365 days
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.db_init" id="apidoc.element.agenda.agenda.prototype.db_init">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>db_init
        <span class="apidocSignatureSpan">( collection, cb )</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">db_init = function ( collection, cb ){
  this._collection = this._mdb.collection(collection || 'agendaJobs');
  var self = this;
  this._collection.createIndexes([{
                                  "key": {"name" : 1, "priority" : -1, "lockedAt" : 1, "nextRunAt" : 1, "disabled" : 1},
                                  "name": "findAndLockNextJobIndex1"
                                }, {
                                  "key": {"name" : 1, "lockedAt" : 1, "priority" : -1, "nextRunAt" : 1, "disabled" : 1},
                                  "name": "findAndLockNextJobIndex2"
                                }],
                                function( err, result ){
                                  handleLegacyCreateIndex(err, result, self, cb)
                                });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.defaultConcurrency" id="apidoc.element.agenda.agenda.prototype.defaultConcurrency">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>defaultConcurrency
        <span class="apidocSignatureSpan">(num)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">defaultConcurrency = function (num) {
  this._defaultConcurrency = num;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

### defaultConcurrency(number)

Takes a `number` which specifies the default number of a specific job that can be running at
any given moment. By default it is `5`.

```js
agenda.<span class="apidocCodeKeywordSpan">defaultConcurrency</span>(5);
```

You can also specify it during instantiation

```js
var agenda = new Agenda({defaultConcurrency: 5});
```
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.defaultLockLifetime" id="apidoc.element.agenda.agenda.prototype.defaultLockLifetime">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>defaultLockLifetime
        <span class="apidocSignatureSpan">(ms)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">defaultLockLifetime = function (ms){
  this._defaultLockLifetime = ms;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
default it is 10 minutes. This can be overridden by specifying the
`lockLifetime` option to a defined job.

A job will unlock if it is finished (ie. `done` is called) before the `lockLifetime`.
The lock is useful if the job crashes or times out.

```js
agenda.<span class="apidocCodeKeywordSpan">defaultLockLifetime</span>(10000);
```

You can also specify it during instantiation

```js
var agenda = new Agenda({defaultLockLifetime: 10000});
```
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.defaultLockLimit" id="apidoc.element.agenda.agenda.prototype.defaultLockLimit">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>defaultLockLimit
        <span class="apidocSignatureSpan">(num)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">defaultLockLimit = function (num) {
  this._defaultLockLimit = num;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
```

### defaultLockLimit(number)

Takes a `number` which specifies the default number of a specific job that can be locked at any given moment. By default it is `
0` for no max.

```js
agenda.<span class="apidocCodeKeywordSpan">defaultLockLimit</span>(0);
```

You can also specify it during instantiation

```js
var agenda = new Agenda({defaultLockLimit: 0});
```
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.define" id="apidoc.element.agenda.agenda.prototype.define">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>define
        <span class="apidocSignatureSpan">(name, options, processor)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">define = function (name, options, processor) {
  if (!processor) {
    processor = options;
    options = {};
  }
  this._definitions[name] = {
    fn: processor,
    concurrency: options.concurrency || this._defaultConcurrency,
    lockLimit: options.lockLimit || this._defaultLockLimit,
    priority: options.priority || 0,
    lockLifetime: options.lockLifetime || this._defaultLockLifetime,
    running: 0,
    locked: 0
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

// or pass additional connection options:
// var agenda = new Agenda({db: {address: mongoConnectionString, collection: "jobCollectionName", options: {server:{auto_reconnect
:true}}}});

// or pass in an existing mongodb-native MongoClient instance
// var agenda = new Agenda({mongo: myMongoClient});

agenda.<span class="apidocCodeKeywordSpan">define</span>('delete old users', function(job, done) {
User.remove({lastLogIn: { $lt: twoDaysAgo }}, done);
});

agenda.on('ready', function() {
agenda.every('3 minutes', 'delete old users');

// Alternatively, you could also do:
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.every" id="apidoc.element.agenda.agenda.prototype.every">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>every
        <span class="apidocSignatureSpan">(interval, names, data, options, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">every = function (interval, names, data, options, cb) {
  var self = this;

  if (cb == undefined &amp;&amp; typeof data == 'function') {
    cb = data;
    data = undefined;
  } else if (cb == undefined &amp;&amp; typeof options == 'function') {
    cb = options;
    options = undefined;
  }

  if (typeof names === 'string' || names instanceof String) {
    return createJob(interval, names, data, options, cb);
  } else if (Array.isArray(names)) {
    return createJobs(interval, names, data, options, cb);
  }

  function createJob(interval, name, data, options, cb) {
    var job = self.create(name, data);
    job.attrs.type = 'single';
    job.repeatEvery(interval, options);
    job.computeNextRunAt();
    job.save(cb);
    return job;
  }

  function createJobs(interval, names, data, options, cb) {
    var results = [];
    var pending = names.length;
    var errored = false;
    return names.map(function (name, i) {
      return createJob(interval, name, data, options, function(err, result) {
        if (err) {
          if (!errored) cb(err);
          errored = true;
          return;
        }
        results[i] = result;
        if (--pending == 0 &amp;&amp; cb) cb(null, results);
      });
    });

  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
// var agenda = new Agenda({mongo: myMongoClient});

agenda.define('delete old users', function(job, done) {
  User.remove({lastLogIn: { $lt: twoDaysAgo }}, done);
});

agenda.on('ready', function() {
  agenda.<span class="apidocCodeKeywordSpan">every</span>('3 minutes', 'delete old users');

  // Alternatively, you could also do:
  agenda.every('*/3 * * * *', 'delete old users');

  agenda.start();
});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.jobs" id="apidoc.element.agenda.agenda.prototype.jobs">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>jobs
        <span class="apidocSignatureSpan">( query, cb )</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">jobs = function ( query, cb ){
  var self = this;
  this._collection.find( query ).toArray( function( error, result ){
    var jobs;
    if( !error ){
      jobs = result.map( createJob.bind( null, self ) );
    }
    cb( error, jobs );
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

### jobs(mongodb-native query)

Lets you query all of the jobs in the agenda job's database. This is a full [mongodb-native](https://github.com/mongodb/node
-mongodb-native)
`find` query. See mongodb-native's documentation for details.

```js
agenda.<span class="apidocCodeKeywordSpan">jobs</span>({name: 'printAnalyticsReport'}, function(err, jobs) {
  // Work with jobs (see below)
});
```

### cancel(mongodb-native query, cb)

Cancels any jobs matching the passed mongodb-native query, and removes them from the database.
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.lockLimit" id="apidoc.element.agenda.agenda.prototype.lockLimit">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>lockLimit
        <span class="apidocSignatureSpan">(num)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">lockLimit = function (num) {
  this._lockLimit = num;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
```

### lockLimit(number)

Takes a `number` which specifies the max number jobs that can be locked at any given moment. By default it is `0` for no max.

```js
agenda.<span class="apidocCodeKeywordSpan">lockLimit</span>(0);
```

You can also specify it during instantiation

```js
var agenda = new Agenda({lockLimit: 0});
```
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.maxConcurrency" id="apidoc.element.agenda.agenda.prototype.maxConcurrency">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>maxConcurrency
        <span class="apidocSignatureSpan">(num)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">maxConcurrency = function (num) {
  this._maxConcurrency = num;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

### maxConcurrency(number)

Takes a `number` which specifies the max number of jobs that can be running at
any given moment. By default it is `20`.

```js
agenda.<span class="apidocCodeKeywordSpan">maxConcurrency</span>(20);
```

You can also specify it during instantiation

```js
var agenda = new Agenda({maxConcurrency: 20});
```
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.mongo" id="apidoc.element.agenda.agenda.prototype.mongo">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>mongo
        <span class="apidocSignatureSpan">( mdb, collection, cb )</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">mongo = function ( mdb, collection, cb ){
  this._mdb = mdb;
  this.db_init(collection, cb);   // NF 20/04/2015
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.name" id="apidoc.element.agenda.agenda.prototype.name">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>name
        <span class="apidocSignatureSpan">(name)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">name = function (name) {
  this._name = name;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
### name(name)

Takes a string `name` and sets `lastModifiedBy` to it in the job database.
Useful for if you have multiple job processors (agendas) and want to see which
job queue last ran the job.

```js
agenda.<span class="apidocCodeKeywordSpan">name</span>(os.hostname + '-' + process.pid);
```

You can also specify it during instantiation

```js
var agenda = new Agenda({name: 'test queue'});
```
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.now" id="apidoc.element.agenda.agenda.prototype.now">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>now
        <span class="apidocSignatureSpan">(name, data, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">now = function (name, data, cb) {
  if (!cb &amp;&amp; typeof data == 'function') {
    cb = data;
    data = undefined;
  }
  var job = this.create(name, data);
  job.schedule(new Date());
  job.save(cb);
  return job;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

`cb` is an optional callback function which will be called when the job has been
persisted in the database.

Returns the `job`.

```js
agenda.<span class="apidocCodeKeywordSpan">now</span>('do the hokey pokey');
```

### create(jobName, data)

Returns an instance of a `jobName` with `data`. This does *NOT* save the job in
the database. See below to learn how to manually work with jobs.
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.processEvery" id="apidoc.element.agenda.agenda.prototype.processEvery">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>processEvery
        <span class="apidocSignatureSpan">(time)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">processEvery = function (time) {
  this._processEvery = humanInterval(time);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
## Configuring an agenda
All configuration methods are chainable, meaning you can do something like:

```js
var agenda = new Agenda();
agenda
  .database(...)
  .<span class="apidocCodeKeywordSpan">processEvery</span>('3 minutes')
  ...;
```

Agenda uses [Human Interval](http://github.com/rschmukler/human-interval) for specifying the intervals. It supports the following
 units:

`seconds`, `minutes`, `hours`, `days`,`weeks`, `months` -- assumes 30 days, `years` -- assumes 365 days
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.purge" id="apidoc.element.agenda.agenda.prototype.purge">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>purge
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">purge = function (cb) {
  var definedNames = Object.keys(this._definitions);
  this.cancel( {name: {$not: {$in: definedNames}}}, cb );   // NF refactored 21/04/2015
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
### purge(cb)

Removes all jobs in the database without defined behaviors. Useful if you change a definition name and want to remove old jobs.

*IMPORTANT:* Do not run this before you finish defining all of your jobs. If you do, you will nuke your database of jobs.

```js
agenda.<span class="apidocCodeKeywordSpan">purge</span>(function(err, numRemoved) {
});
```

## Starting the job processor

To get agenda to start processing jobs from the database you must start it. This
will schedule an interval (based on `processEvery`) to check for new jobs and
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.saveJob" id="apidoc.element.agenda.agenda.prototype.saveJob">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>saveJob
        <span class="apidocSignatureSpan">(job, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">saveJob = function (job, cb) {
  var fn = cb,
      self = this;

  var props = job.toJSON();
  var id = job.attrs._id;
  var unique = job.attrs.unique;
  var uniqueOpts = job.attrs.uniqueOpts;

  delete props._id;
  delete props.unique;
  delete props.uniqueOpts;

  props.lastModifiedBy = this._name;

  var now = new Date(),
      protect = {},
      update = { $set: props };

  if (id) {
    this._collection.findAndModify({_id: id}, {}, update, {new: true}, processDbResult );
  } else if (props.type == 'single') {
    if (props.nextRunAt &amp;&amp; props.nextRunAt &lt;= now) {
      protect.nextRunAt = props.nextRunAt;
      delete props.nextRunAt;
    }
    if (Object.keys(protect).length &gt; 0) {
      update.$setOnInsert = protect;
    }
    // Try an upsert.
    this._collection.findAndModify({name: props.name, type: 'single'}, {}, update, {upsert: true, new: true}, processDbResult);
  } else if (unique) {
    var query = job.attrs.unique;
    query.name = props.name;
    if( uniqueOpts &amp;&amp; uniqueOpts.insertOnly )
      update = { $setOnInsert: props };
    this._collection.findAndModify(query, {}, update, {upsert: true, new: true}, processDbResult);
  } else {
    this._collection.insertOne(props, processDbResult);    // NF updated 22/04/2015
  }

  function processDbResult(err, result) {
    if (err) {
      if (fn) {
        return fn(err);
      } else {
        throw err;
      }
    } else if (result) {
      var res = result.ops ? result.ops : result.value;     // result is different for findAndModify() vs. insertOne(). NF 20/04
/2015
      if ( res ){
        if (Array.isArray(res)) {
          res = res[0];
        }

        job.attrs._id = res._id;
        job.attrs.nextRunAt = res.nextRunAt;

        if (job.attrs.nextRunAt &amp;&amp; job.attrs.nextRunAt &lt; self._nextScanAt) {
          processJobs.call(self, job);
        }
      }
    }

    if (fn) {
      fn(null, job);
    }
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  if (this.attrs.lockedAt &amp;&amp; this.attrs.lastRunAt.getTime() &gt; this.attrs.lastFinishedAt.getTime()) {
    return true;
  }
  return false;
};

Job.prototype.save = function(cb) {
  this.agenda.<span class="apidocCodeKeywordSpan">saveJob</span>(this, cb);
  return this;
};

Job.prototype.remove = function(cb) {
  // refactored NF 21/04/2015
  this.agenda.cancel( {_id: this.attrs._id}, cb );
/*
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.schedule" id="apidoc.element.agenda.agenda.prototype.schedule">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>schedule
        <span class="apidocSignatureSpan">(when, names, data, cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">schedule = function (when, names, data, cb) {
  var self = this;

  if (cb == undefined &amp;&amp; typeof data == 'function') {
    cb = data;
    data = undefined;
  }

  if (typeof names === 'string' || names instanceof String) {
    return createJob(when, names, data, cb);
  } else if (Array.isArray(names)) {
    return createJobs(when, names, data, cb);
  }


  function createJob(when, name, data, cb) {
    var job = self.create(name, data);
    job.schedule(when);
    job.save(cb);
    return job;
  }

  function createJobs(when, names, data, cb) {
    var results = [];
    var pending = names.length;
    var errored = false;
    return names.map(function (name, i) {
      return createJob(when, name, data, function(err, result) {
        if (err) {
          if (!errored) cb(err);
          errored = true;
          return;
        }
        results[i] = result;
        if (--pending == 0 &amp;&amp; cb) cb(null, results);
      });
    });
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  from: 'example@example.com',
  subject: 'Email Report',
  body: '...'
}, done);
});

agenda.on('ready', function() {
agenda.<span class="apidocCodeKeywordSpan">schedule</span>('in 20 minutes', 'send email report', {to: '
admin@example.com'});
agenda.start();
});
```

```js
agenda.on('ready', function() {
var weeklyReport = agenda.create('send email report', {to: 'another-guy@example.com'})
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.start" id="apidoc.element.agenda.agenda.prototype.start">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>start
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">start = function () {
  if (!this._processInterval) {
    this._processInterval = setInterval(processJobs.bind(this), this._processEvery);
    process.nextTick(processJobs.bind(this));
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

agenda.on('ready', function() {
agenda.every('3 minutes', 'delete old users');

// Alternatively, you could also do:
agenda.every('*/3 * * * *', 'delete old users');

agenda.<span class="apidocCodeKeywordSpan">start</span>();
});

```

```js
agenda.define('send email report', {priority: 'high', concurrency: 10}, function(job, done) {
var data = job.attrs.data;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.agenda.prototype.stop" id="apidoc.element.agenda.agenda.prototype.stop">
        function <span class="apidocSignatureSpan">agenda.agenda.prototype.</span>stop
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">stop = function (cb) {
  cb = cb || function() {};
  clearInterval(this._processInterval);
  this._processInterval = undefined;
  this._unlockJobs(cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

This can be very useful for graceful shutdowns so that currently running/grabbed jobs are abandoned so that other
job queues can grab them / they are unlocked should the job queue start again. Here is an example of how to do a graceful
shutdown.

```js
function graceful() {
  agenda.<span class="apidocCodeKeywordSpan">stop</span>(function() {
    process.exit(0);
  });
}

process.on('SIGTERM', graceful);
process.on('SIGINT' , graceful);
```
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.agenda.job" id="apidoc.module.agenda.job">module agenda.job</a></h1>


    <h2>
        <a href="#apidoc.element.agenda.job.job" id="apidoc.element.agenda.job.job">
        function <span class="apidocSignatureSpan">agenda.</span>job
        <span class="apidocSignatureSpan">(args)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Job(args) {
  args = args || {};

  // Remove special args
  this.agenda = args.agenda;
  delete args.agenda;

  // Process args
  args.priority = parsePriority(args.priority) || 0;

  // Set attrs to args
  var attrs = {};
  for (var key in args) {
    if (args.hasOwnProperty(key)) {
      attrs[key] = args[key];
    }
  }

  // Set defaults if undefined
  attrs.nextRunAt = attrs.nextRunAt || new Date();
  attrs.type = attrs.type || 'once';
  this.attrs = attrs;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.agenda.job.prototype" id="apidoc.module.agenda.job.prototype">module agenda.job.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.agenda.job.prototype.computeNextRunAt" id="apidoc.element.agenda.job.prototype.computeNextRunAt">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>computeNextRunAt
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">computeNextRunAt = function () {
  var interval = this.attrs.repeatInterval;
  var timezone = this.attrs.repeatTimezone;
  var repeatAt = this.attrs.repeatAt;
  this.attrs.nextRunAt = undefined;

  if (interval) {
    computeFromInterval.call(this);
  } else if (repeatAt) {
    computeFromRepeatAt.call(this);
  }
  return this;

  function dateForTimezone (d) {
    d = moment(d);
    if(timezone) d.tz(timezone);
    return d;
  }

  function computeFromInterval() {
    var lastRun = this.attrs.lastRunAt || new Date();
    lastRun = dateForTimezone(lastRun);
    try {
      var cronTime = new CronTime(interval);
      var nextDate = cronTime._getNextDateFrom(lastRun);
      if (nextDate.valueOf() == lastRun.valueOf()) {
        // Handle cronTime giving back the same date for the next run time
        nextDate = cronTime._getNextDateFrom(dateForTimezone(new Date(lastRun.valueOf() + 1000)));
      }
      this.attrs.nextRunAt = nextDate;
    } catch (e) {
      // Nope, humanInterval then!
      try {
        if (!this.attrs.lastRunAt &amp;&amp; humanInterval(interval)) {
          this.attrs.nextRunAt = lastRun.valueOf();
        } else {
          this.attrs.nextRunAt = lastRun.valueOf() + humanInterval(interval);
        }
      } catch (e) {}
    } finally {
      if (isNaN(this.attrs.nextRunAt)) {
        this.attrs.nextRunAt = undefined;
        this.fail('failed to calculate nextRunAt due to invalid repeat interval');
      }
    }
  }

  function computeFromRepeatAt() {
    var lastRun = this.attrs.lastRunAt || new Date();
    var nextDate = date(repeatAt).valueOf();

    var offset = Date.now();  // if you do not specify offset date for below test it will fail for ms
    if (offset === date(repeatAt,offset).valueOf()) {
      this.attrs.nextRunAt = undefined;
      this.fail('failed to calculate repeatAt time due to invalid format');
    } else if (nextDate.valueOf() == lastRun.valueOf()) {
      this.attrs.nextRunAt = date('tomorrow at ', repeatAt);
    } else {
      this.attrs.nextRunAt = date(repeatAt);
    }
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  var self = this,
      agenda = self.agenda,
      definition = agenda._definitions[self.attrs.name];

  var setImmediate = setImmediate || process.nextTick;
  setImmediate(function() {
    self.attrs.lastRunAt = new Date();
    self.<span class="apidocCodeKeywordSpan">computeNextRunAt</span>();
    self.save(function() {
      var jobCallback = function(err) {
if (err) {
  self.fail(err);
}

self.attrs.lastFinishedAt = new Date();
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.disable" id="apidoc.element.agenda.job.prototype.disable">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>disable
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">disable = function () {
  this.attrs.disabled = true;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.enable" id="apidoc.element.agenda.job.prototype.enable">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>enable
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">enable = function () {
  this.attrs.disabled = false;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.fail" id="apidoc.element.agenda.job.prototype.fail">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>fail
        <span class="apidocSignatureSpan">(reason)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">fail = function (reason) {
  if(reason instanceof Error) {
    reason = reason.message;
  }
  this.attrs.failReason = reason;
  this.attrs.failCount = (this.attrs.failCount || 0) + 1;
  this.attrs.failedAt = new Date();
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
Sets `job.attrs.failedAt` to `now`, and sets `job.attrs.failReason`
to `reason`.

Optionally, `reason` can be an error, in which case `job.attrs.failReason` will
be set to `error.message`

```js
job.<span class="apidocCodeKeywordSpan">fail</span>('insuficient disk space');
// or
job.fail(new Error('insufficient disk space'));
job.save();
```

### run(callback)
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.isRunning" id="apidoc.element.agenda.job.prototype.isRunning">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>isRunning
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">isRunning = function () {
  if (!this.attrs.lastRunAt) return false;
  if (!this.attrs.lastFinishedAt) return true;
  if (this.attrs.lockedAt &amp;&amp; this.attrs.lastRunAt.getTime() &gt; this.attrs.lastFinishedAt.getTime()) {
    return true;
  }
  return false;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.priority" id="apidoc.element.agenda.job.prototype.priority">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>priority
        <span class="apidocSignatureSpan">(priority)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">priority = function (priority) {
  this.attrs.priority = parsePriority(priority);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

### priority(priority)

Specifies the `priority` weighting of the job. Can be a number or a string from
the above priority table.

```js
job.<span class="apidocCodeKeywordSpan">priority</span>('low');
job.save();
```

### unique(properties, [options])

Ensure that only one instance of this job exists with the specified properties
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.remove" id="apidoc.element.agenda.job.prototype.remove">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>remove
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">remove = function (cb) {
  // refactored NF 21/04/2015
  this.agenda.cancel( {_id: this.attrs._id}, cb );
<span class="apidocCodeCommentSpan">/*
  var self = this;
  this.agenda._db.remove({_id: this.attrs._id}, function(err, count) {
    if(err) {
      return cb(err);
    }
    cb(err, count);
  });
*/
</span>}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
// or pass additional connection options:
// var agenda = new Agenda({db: {address: mongoConnectionString, collection: "jobCollectionName", options: {server:{auto_reconnect
:true}}}});

// or pass in an existing mongodb-native MongoClient instance
// var agenda = new Agenda({mongo: myMongoClient});

agenda.define('delete old users', function(job, done) {
User.<span class="apidocCodeKeywordSpan">remove</span>({lastLogIn: { $lt: twoDaysAgo }}, done);
});

agenda.on('ready', function() {
agenda.every('3 minutes', 'delete old users');

// Alternatively, you could also do:
agenda.every('*/3 * * * *', 'delete old users');
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.repeatAt" id="apidoc.element.agenda.job.prototype.repeatAt">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>repeatAt
        <span class="apidocSignatureSpan">(time)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">repeatAt = function (time) {
  this.attrs.repeatAt = time;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
```

### repeatAt(time)

Specifies a `time` when the job should repeat. [Possible values](https://github.com/matthewmueller/date#examples)

```js
job.<span class="apidocCodeKeywordSpan">repeatAt</span>('3:30pm');
job.save();
```

### schedule(time)

Specifies the next `time` at which the job should run.
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.repeatEvery" id="apidoc.element.agenda.job.prototype.repeatEvery">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>repeatEvery
        <span class="apidocSignatureSpan">(interval, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">repeatEvery = function (interval, options) {
  options = options || {};
  this.attrs.repeatInterval = interval;
  this.attrs.repeatTimezone = options.timezone ? options.timezone : null;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  agenda.start();
});
```

```js
agenda.on('ready', function() {
  var weeklyReport = agenda.create('send email report', {to: 'another-guy@example.com'})
  weeklyReport.<span class="apidocCodeKeywordSpan">repeatEvery</span>('1 week').save();
  agenda.start();
});
```

# Full documentation

Agenda's basic control structure is an instance of an agenda. Agenda's are
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.run" id="apidoc.element.agenda.job.prototype.run">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>run
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">run = function (cb) {
  var self = this,
      agenda = self.agenda,
      definition = agenda._definitions[self.attrs.name];

  var setImmediate = setImmediate || process.nextTick;
  setImmediate(function() {
    self.attrs.lastRunAt = new Date();
    self.computeNextRunAt();
    self.save(function() {
      var jobCallback = function(err) {
        if (err) {
          self.fail(err);
        }

        self.attrs.lastFinishedAt = new Date();
        self.attrs.lockedAt = null;
        self.save(function(saveErr, job) {
          cb &amp;&amp; cb(err || saveErr, job);
          if (err) {
            agenda.emit('fail', err, self);
            agenda.emit('fail:' + self.attrs.name, err, self);
          } else {
            agenda.emit('success', self);
            agenda.emit('success:' + self.attrs.name, self);
          }
          agenda.emit('complete', self);
          agenda.emit('complete:' + self.attrs.name, self);
        });
      };

      try {
        agenda.emit('start', self);
        agenda.emit('start:' + self.attrs.name, self);
        if (!definition) {
          throw new Error('Undefined job');
        }
        if (definition.fn.length === 2) {
          definition.fn(self, jobCallback);
        } else {
          definition.fn(self);
          jobCallback();
        }
      } catch (e) {
        jobCallback(e);
      }
    });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

### run(callback)

Runs the given `job` and calls `callback(err, job)` upon completion. Normally
you never need to call this manually.

```js
job.<span class="apidocCodeKeywordSpan">run</span>(function(err, job) {
  console.log("I don't know why you would need to do this...");
});
```

### save(callback)

Saves the `job.attrs` into the database.
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.save" id="apidoc.element.agenda.job.prototype.save">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>save
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">save = function (cb) {
  this.agenda.saveJob(this, cb);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  agenda.start();
});
```

```js
agenda.on('ready', function() {
  var weeklyReport = agenda.create('send email report', {to: 'another-guy@example.com'})
  weeklyReport.repeatEvery('1 week').<span class="apidocCodeKeywordSpan">save</span>();
  agenda.start();
});
```

# Full documentation

Agenda's basic control structure is an instance of an agenda. Agenda's are
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.schedule" id="apidoc.element.agenda.job.prototype.schedule">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>schedule
        <span class="apidocSignatureSpan">(time)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">schedule = function (time) {
  this._scheduled = true;
  this.attrs.nextRunAt = (time instanceof Date) ? time : date(time);
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  from: 'example@example.com',
  subject: 'Email Report',
  body: '...'
}, done);
});

agenda.on('ready', function() {
agenda.<span class="apidocCodeKeywordSpan">schedule</span>('in 20 minutes', 'send email report', {to: '
admin@example.com'});
agenda.start();
});
```

```js
agenda.on('ready', function() {
var weeklyReport = agenda.create('send email report', {to: 'another-guy@example.com'})
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.toJSON" id="apidoc.element.agenda.job.prototype.toJSON">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>toJSON
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toJSON = function () { // create a persistable Mongo object -RR
    var self = this,
        attrs = self.attrs || {};

    var result = {};

    for (var prop in attrs) {
      if (attrs.hasOwnProperty(prop)) {
        result[prop] = attrs[prop];
      }
    }

    var dates = ['lastRunAt', 'lastFinishedAt', 'nextRunAt', 'failedAt', 'lockedAt'];
    dates.forEach(function(d) {
      if (result[d]) {
        result[d] = new Date(result[d]);
      }
    });

    return result;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.touch" id="apidoc.element.agenda.job.prototype.touch">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>touch
        <span class="apidocSignatureSpan">(cb)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">touch = function (cb) {
  this.attrs.lockedAt = new Date();
  this.save(cb);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

Resets the lock on the job. Useful to indicate that the job hasn't timed out
when you have very long running jobs.

```js
agenda.define('super long job', function(job, done) {
doSomeLongTask(function() {
  job.<span class="apidocCodeKeywordSpan">touch</span>(function() {
    doAnotherLongTask(function() {
      job.touch(function() {
        finishOurLongTasks(done);
      });
    });
  });
});
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.agenda.job.prototype.unique" id="apidoc.element.agenda.job.prototype.unique">
        function <span class="apidocSignatureSpan">agenda.job.prototype.</span>unique
        <span class="apidocSignatureSpan">(unique, opts)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">unique = function (unique, opts) {
  this.attrs.unique = unique;
  this.attrs.uniqueOpts = opts;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

`options` is an optional argument which can overwrite the defaults. It can take
the following:

- `insertOnly`: `boolean` will prevent any properties from persisting if job already exists. Defaults to false.

```js
job.<span class="apidocCodeKeywordSpan">unique</span>({'data.type': 'active', 'data.userId': '
;123', nextRunAt(date)});
job.save();
```

### fail(reason)

Sets `job.attrs.failedAt` to `now`, and sets `job.attrs.failReason`
to `reason`.
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
</body></html>